import React, { useState, useEffect } from 'react';
import {
  Container,
  Grid,
  Paper,
  Typography,
  Box,
  Card,
  CardContent,
  Divider,
  Avatar,
  Chip,
  List,
  ListItem,
  ListItemText,
  ListItemIcon,
  ListItemButton,
  Button,
  useTheme,
  Stack,
  Tab,
  Tabs,
  Alert,
  IconButton,
  Badge,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  Select,
  MenuItem,
  FormControl,
  InputLabel,
  TableContainer,
  Table,
  TableHead,
  TableRow,
  TableCell,
  TableBody,
  LinearProgress,
  Tooltip,
  CircularProgress
} from '@mui/material';
import { useNavigate } from 'react-router-dom';
import { useAppContext } from '../context/AppContext';
import { supervisors, teacherAttendanceData, studentTransferRequests, supervisorAIRecommendations } from '../data/supervisors';
import { students } from '../data/students';
import { mosques } from '../data/mosques';
import { studentAnalytics } from '../data/ai-insights';
// ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿÆÿØŸÖÿ© ÿßŸÑŸÖÿ¥ÿ±ŸÅ ÿßŸÑÿ≠ŸÇŸäŸÇŸäÿ©
import supervisorService, { 
  SupervisorDashboardData, 
  SupervisorTeacher, 
  SupervisorStudent, 
  SupervisorCircle,
  SupervisorStatistics 
} from '../services/supervisorService';

// ÿ£ŸäŸÇŸàŸÜÿßÿ™
import SupervisorAccountIcon from '@mui/icons-material/SupervisorAccount';
import SchoolIcon from '@mui/icons-material/School';
import PeopleIcon from '@mui/icons-material/People';
import AssignmentIcon from '@mui/icons-material/Assignment';
import CalendarTodayIcon from '@mui/icons-material/CalendarToday';
import TrendingUpIcon from '@mui/icons-material/TrendingUp';
import TrendingDownIcon from '@mui/icons-material/TrendingDown';
import TrendingFlatIcon from '@mui/icons-material/TrendingFlat';
import CheckCircleIcon from '@mui/icons-material/CheckCircle';
import ErrorIcon from '@mui/icons-material/Error';
import WarningIcon from '@mui/icons-material/Warning';
import TransferWithinAStationIcon from '@mui/icons-material/TransferWithinAStation';
import SmartToyIcon from '@mui/icons-material/SmartToy';
import ReportIcon from '@mui/icons-material/Report';
import PersonAddIcon from '@mui/icons-material/PersonAdd';
import EditIcon from '@mui/icons-material/Edit';
import SwapHorizIcon from '@mui/icons-material/SwapHoriz';
import NotificationsIcon from '@mui/icons-material/Notifications';
import MosqueIcon from '@mui/icons-material/Mosque';
import EventAvailableIcon from '@mui/icons-material/EventAvailable';
import EventBusyIcon from '@mui/icons-material/EventBusy';
import AccessTimeIcon from '@mui/icons-material/AccessTime';
import VacationIcon from '@mui/icons-material/BeachAccess';

interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

function TabPanel(props: TabPanelProps) {
  const { children, value, index, ...other } = props;
  return (
    <div
      role="tabpanel"
      hidden={value !== index}
      id={`supervisor-tabpanel-${index}`}
      aria-labelledby={`supervisor-tab-${index}`}
      {...other}
    >
      {value === index && <Box sx={{ p: 3 }}>{children}</Box>}
    </div>
  );
}

const SupervisorDashboard: React.FC = () => {
  const navigate = useNavigate();
  const theme = useTheme();
  const { user } = useAppContext();
  const [activeTab, setActiveTab] = useState(0);
  const [transferDialogOpen, setTransferDialogOpen] = useState(false);
  const [selectedStudent, setSelectedStudent] = useState('');
  const [transferReason, setTransferReason] = useState('');
  const [targetMosque, setTargetMosque] = useState('');
  const [attendanceDialogOpen, setAttendanceDialogOpen] = useState(false);
  const [selectedTeacher, setSelectedTeacher] = useState('');
  const [attendanceStatus, setAttendanceStatus] = useState('');
  const [attendanceNotes, setAttendanceNotes] = useState('');

  // ÿ≠ÿßŸÑÿßÿ™ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ API
  const [loading, setLoading] = useState(true);
  const [dashboardData, setDashboardData] = useState<SupervisorDashboardData | null>(null);
  const [supervisorTeachers, setSupervisorTeachers] = useState<SupervisorTeacher[]>([]);
  const [supervisorStudents, setSupervisorStudents] = useState<SupervisorStudent[]>([]);
  const [supervisorCircles, setSupervisorCircles] = useState<SupervisorCircle[]>([]);
  const [supervisorStats, setSupervisorStats] = useState<SupervisorStatistics | null>(null);
  const [error, setError] = useState<string | null>(null);

  // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±ŸÅ ÿßŸÑÿ≠ÿßŸÑŸä (ŸÖÿ§ŸÇÿ™ÿßŸã ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©)
  const currentSupervisor = supervisors[0];
  const supervisedMosquesList = mosques.filter(m => currentSupervisor.supervisedMosques.includes(m.id));
  const supervisedStudents = students.filter(s => currentSupervisor.supervisedMosques.includes(s.mosqueId));
  const todayAttendance = teacherAttendanceData.filter(ta => ta.date === '2025-06-07' && currentSupervisor.supervisedMosques.includes(ta.mosqueId));

  // ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ APIs ÿßŸÑÿ≠ŸÇŸäŸÇŸäÿ©
  useEffect(() => {
    const fetchSupervisorData = async () => {
      try {
        setLoading(true);
        setError(null);
        
        console.log('üöÄ ÿ®ÿØÿ° ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±ŸÅ');
        
        // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ¥ÿ±ŸÅ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä (ŸÖÿ§ŸÇÿ™ÿßŸã ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ±ŸÇŸÖ 1)
        const supervisorId = 1;
        
        // ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿßŸÖŸÑÿ©
        const completeData = await supervisorService.getSupervisorCompleteData(supervisorId, user?.token);
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ÿßŸÑÿßÿ™
        setDashboardData(completeData.dashboard);
        setSupervisorTeachers(completeData.teachers);
        setSupervisorStudents(completeData.students);
        setSupervisorCircles(completeData.circles);
        setSupervisorStats(completeData.statistics);
        
        console.log('‚úÖ ÿ™ŸÖ ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±ŸÅ ÿ®ŸÜÿ¨ÿßÿ≠:', completeData);
        
      } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±ŸÅ:', error);
        setError('ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±ŸÅ');
      } finally {
        setLoading(false);
      }
    };

    fetchSupervisorData();
  }, [user?.id, user?.token]);
  // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±ŸÅ (ŸÖÿ≠ÿØÿ´ÿ© ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ API)
  const getSupervisorStats = () => {
    if (loading || !supervisorStats) {
      // ÿ•ÿ±ÿ¨ÿßÿπ ŸÇŸäŸÖ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
      return {
        totalMosques: 0,
        totalStudents: 0,
        attendanceRate: 0,
        pendingTransfers: 0,
        presentTeachers: 0,
        totalTeachers: 0
      };
    }

    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ API
    const totalMosques = new Set(supervisorCircles.map(c => c.mosque.id)).size;
    const totalStudents = supervisorStudents.length;
    const totalTeachers = supervisorTeachers.length;
    
    // ÿ≠ÿ≥ÿßÿ® ŸÖÿπÿØŸÑ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÖŸÜ ÿ®ŸäÿßŸÜÿßÿ™ API (ŸÖÿ§ŸÇÿ™ÿßŸã ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©)
    const presentTeachers = todayAttendance.filter(ta => ta.status === 'ÿ≠ÿßÿ∂ÿ±').length;
    const attendanceRate = totalTeachers > 0 ? Math.round((presentTeachers / totalTeachers) * 100) : 0;
    const pendingTransfers = studentTransferRequests.filter(str => str.status === 'pending').length;

    return {
      totalMosques,
      totalStudents,
      attendanceRate,
      pendingTransfers,
      presentTeachers: presentTeachers || 0,
      totalTeachers
    };
  };

  const stats = getSupervisorStats();
  // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ® ŸÜŸÇŸÑ ÿ∑ÿßŸÑÿ® - ŸÖÿ≠ÿØÿ´ ŸÑŸÑÿπŸÖŸÑ ŸÖÿπ APIs
  const handleStudentTransfer = async () => {
    try {
      // ŸÅŸä ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ≠ŸÇŸäŸÇŸä ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ® ŸÑŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
      console.log('ÿ∑ŸÑÿ® ŸÜŸÇŸÑ:', {
        studentId: selectedStudent,
        targetMosque,
        reason: transferReason
      });
      
      // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑŸÜŸÇŸÑ ÿ•ŸÑŸâ API ŸáŸÜÿß
      // await supervisorService.transferStudent(selectedStudent, targetMosque, transferReason);
      
      setTransferDialogOpen(false);
      setSelectedStudent('');
      setTransferReason('');
      setTargetMosque('');
      
      // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠
      alert('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑŸÜŸÇŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑŸÜŸÇŸÑ:', error);
      alert('ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑŸÜŸÇŸÑ');
    }
  };

  // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑŸÖÿπŸÑŸÖ - ŸÖÿ≠ÿØÿ´ ŸÑŸÑÿπŸÖŸÑ ŸÖÿπ APIs
  const handleTeacherAttendance = async () => {
    try {
      console.log('ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑŸÖÿπŸÑŸÖ:', {
        teacherId: selectedTeacher,
        status: attendanceStatus,
        notes: attendanceNotes
      });
      
      // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ≠ÿ∂Ÿàÿ± ÿßŸÑŸÖÿπŸÑŸÖ ÿ•ŸÑŸâ API ŸáŸÜÿß
      // await supervisorService.recordTeacherAttendance(selectedTeacher, attendanceStatus, attendanceNotes);
      
      setAttendanceDialogOpen(false);
      setSelectedTeacher('');
      setAttendanceStatus('');
      setAttendanceNotes('');
      
      // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠
      alert('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≠ÿ∂Ÿàÿ±:', error);
      alert('ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≠ÿ∂Ÿàÿ±');
    }
  };

  // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑÿ≠ÿ∂Ÿàÿ±
  const getAttendanceIcon = (status: string) => {
    switch (status) {
      case 'ÿ≠ÿßÿ∂ÿ±':
        return <EventAvailableIcon color="success" />;
      case 'ÿ∫ÿßÿ¶ÿ®':
        return <EventBusyIcon color="error" />;
      case 'ŸÖÿ™ÿ£ÿÆÿ±':
        return <AccessTimeIcon color="warning" />;
      case 'ÿ•ÿ¨ÿßÿ≤ÿ©':
        return <VacationIcon color="info" />;
      default:
        return <EventAvailableIcon />;
    }
  };

  // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÑŸàŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿ∂Ÿàÿ±
  const getAttendanceColor = (status: string) => {
    switch (status) {
      case 'ÿ≠ÿßÿ∂ÿ±':
        return 'success';
      case 'ÿ∫ÿßÿ¶ÿ®':
        return 'error';
      case 'ŸÖÿ™ÿ£ÿÆÿ±':
        return 'warning';
      case 'ÿ•ÿ¨ÿßÿ≤ÿ©':
        return 'info';
      default:
        return 'default';
    }
  };  return (
    <Box 
      sx={{
        minHeight: '100vh',
        pt: 8,
        pb: 4,
        background: theme.palette.mode === 'light' 
          ? 'linear-gradient(180deg, rgba(245,247,250,1) 0%, rgba(255,255,255,1) 100%)'
          : 'linear-gradient(180deg, rgba(10,25,47,1) 0%, rgba(17,34,64,1) 100%)'
      }}
    >
      <Container maxWidth="lg">
        {/* ÿπÿ±ÿ∂ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ */}
        {loading && (
          <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '60vh' }}>
            <Box sx={{ textAlign: 'center' }}>
              <CircularProgress size={60} sx={{ mb: 2 }} />
              <Typography variant="h6" color="text.secondary">
                ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±ŸÅ...
              </Typography>
            </Box>
          </Box>
        )}        {/* ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£ ŸÖÿπ ÿ≤ÿ± ÿßŸÑÿ•ÿπÿßÿØÿ© */}
        {error && !loading && (
          <Alert 
            severity="error" 
            sx={{ mb: 3 }}
            action={
              <Button 
                color="inherit" 
                size="small" 
                onClick={() => window.location.reload()}
              >
                ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©
              </Button>
            }
          >
            {error}
          </Alert>
        )}

        {/* ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä */}
        {!loading && !error && (
          <>
            {/* ÿ±ÿ£ÿ≥ ÿßŸÑÿµŸÅÿ≠ÿ© - ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±ŸÅ (ŸÖÿ≠ÿØÿ´ ÿ®ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ API) */}
            <Paper
              elevation={0}
              sx={{
                p: 3,
                mb: 4,
                borderRadius: 3,
                background: theme.palette.mode === 'light' 
                  ? 'linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%)'
                  : 'linear-gradient(135deg, #4caf50 0%, #2e7d32 100%)',
                color: 'white',
                position: 'relative',
                overflow: 'hidden'
              }}
            >
              {/* ÿÆŸÑŸÅŸäÿ© ÿ≤ÿÆÿ±ŸÅŸäÿ© */}
              <Box
                sx={{
                  position: 'absolute',
                  top: -50,
                  right: -50,
                  width: 200,
                  height: 200,
                  borderRadius: '50%',
                  background: 'rgba(255,255,255,0.05)',
                  zIndex: 0
                }}
              />
            
              <Box sx={{ position: 'relative', zIndex: 1 }}>
                <Grid container spacing={3} alignItems="center">
                  <Grid item xs={12} md={8}>
                    <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>
                      <Avatar 
                        sx={{ 
                          bgcolor: 'rgba(255,255,255,0.2)', 
                          mr: 2,
                          width: 60,
                          height: 60
                        }}
                      >
                        <SupervisorAccountIcon sx={{ fontSize: 30 }} />
                      </Avatar>
                      <Box>
                        <Typography variant="h4" component="h1" fontWeight="bold">
                          {dashboardData?.data?.welcome_message || `ÿ£ŸáŸÑÿßŸã Ÿàÿ≥ŸáŸÑÿßŸã ${currentSupervisor.name.split(' ')[0]}`}
                        </Typography>
                        <Typography variant="body1" sx={{ opacity: 0.9, mt: 0.5 }}>
                          ŸÑŸàÿ≠ÿ© ÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ¥ÿ±ŸÅ - ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≠ŸÑŸÇÿßÿ™ ŸàÿßŸÑŸÖÿπŸÑŸÖŸäŸÜ
                        </Typography>
                      </Box>
                    </Box>
                    
                    {/* ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ© ŸÖÿ≠ÿØÿ´ÿ© */}
                    <Grid container spacing={2}>
                      <Grid item xs={6} sm={3}>
                        <Box sx={{ textAlign: 'center' }}>
                          <Typography variant="h6" fontWeight="bold">
                            {stats.totalMosques}
                          </Typography>
                          <Typography variant="caption" sx={{ opacity: 0.8 }}>
                            ÿßŸÑŸÖÿ≥ÿßÿ¨ÿØ
                          </Typography>
                        </Box>
                      </Grid>
                      <Grid item xs={6} sm={3}>
                        <Box sx={{ textAlign: 'center' }}>
                          <Typography variant="h6" fontWeight="bold">
                            {stats.totalStudents}
                          </Typography>
                          <Typography variant="caption" sx={{ opacity: 0.8 }}>
                            ÿßŸÑÿ∑ŸÑÿßÿ®
                          </Typography>
                        </Box>
                      </Grid>
                      <Grid item xs={6} sm={3}>
                        <Box sx={{ textAlign: 'center' }}>
                          <Typography variant="h6" fontWeight="bold">
                            {stats.attendanceRate}%
                          </Typography>
                          <Typography variant="caption" sx={{ opacity: 0.8 }}>
                            ÿ≠ÿ∂Ÿàÿ± ÿßŸÑŸÖÿπŸÑŸÖŸäŸÜ
                          </Typography>
                        </Box>
                      </Grid>
                      <Grid item xs={6} sm={3}>
                        <Box sx={{ textAlign: 'center' }}>
                          <Typography variant="h6" fontWeight="bold">
                            {stats.pendingTransfers}
                          </Typography>
                          <Typography variant="caption" sx={{ opacity: 0.8 }}>
                            ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÜŸÇŸÑ
                          </Typography>
                        </Box>
                      </Grid>
                    </Grid>
                  </Grid>
                  
                  <Grid item xs={12} md={4}>
                    <Card 
                      sx={{ 
                        bgcolor: 'rgba(255,255,255,0.1)',
                        backdropFilter: 'blur(10px)',
                        border: '1px solid rgba(255,255,255,0.2)'
                      }}
                    >
                      <CardContent>
                        <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>
                          <NotificationsIcon sx={{ mr: 1, color: 'white' }} />
                          <Typography variant="h6" color="white">
                            ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™ ÿßŸÑÿπÿßÿ¨ŸÑÿ©
                          </Typography>
                        </Box>
                        <Typography variant="body2" sx={{ color: 'rgba(255,255,255,0.8)', mb: 1 }}>
                          {dashboardData?.data?.notifications?.pending_reports || 0} ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿπŸÑŸÇ
                        </Typography>
                        <Typography variant="body2" sx={{ color: 'rgba(255,255,255,0.8)', mb: 1 }}>
                          {dashboardData?.data?.notifications?.new_students || 0} ÿ∑ÿßŸÑÿ® ÿ¨ÿØŸäÿØ
                        </Typography>
                        <Typography variant="body2" sx={{ color: 'rgba(255,255,255,0.8)' }}>
                          {supervisorAIRecommendations.filter(r => r.priority === 'high').length} ÿ™ŸàÿµŸäÿ© ÿ∞ŸÉÿßÿ° ÿßÿµÿ∑ŸÜÿßÿπŸä ÿπÿßŸÑŸäÿ© ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©
                        </Typography>
                      </CardContent>
                    </Card>
                  </Grid>
                </Grid>
              </Box>
            </Paper>
          </>
        )}

        {/* ÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ */}
        <Paper elevation={0} sx={{ borderRadius: 3, overflow: 'hidden', mb: 3 }}>
          <Tabs
            value={activeTab}
            onChange={(_, newValue) => setActiveTab(newValue)}
            sx={{ 
              borderBottom: '1px solid',
              borderColor: 'divider',
              '& .MuiTabs-indicator': {
                backgroundColor: theme.palette.primary.main
              }
            }}
          >
            <Tab label="ŸÜÿ∏ÿ±ÿ© ÿπÿßŸÖÿ©" />
            <Tab label="ÿßŸÑŸÖÿ≥ÿßÿ¨ÿØ ŸàÿßŸÑÿ≠ŸÑŸÇÿßÿ™" />
            <Tab label="ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑŸÖÿπŸÑŸÖŸäŸÜ" />
            <Tab label="ŸÜŸÇŸÑ ÿßŸÑÿ∑ŸÑÿßÿ®" />
            <Tab label="ÿßŸÑÿ™ŸàÿµŸäÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©" />
            <Tab label="ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±" />
          </Tabs>
        </Paper>

        {/* ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ */}
        
        {/* ÿ™ÿ®ŸàŸäÿ®ÿ© ŸÜÿ∏ÿ±ÿ© ÿπÿßŸÖÿ© */}
        <TabPanel value={activeTab} index={0}>
          <Grid container spacing={3}>
            {/* ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ */}
            <Grid item xs={12} md={6} lg={3}>
              <Card elevation={0} sx={{ p: 2, borderRadius: 3, bgcolor: 'primary.light', color: 'primary.contrastText' }}>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <Box>
                    <Typography variant="h4" fontWeight="bold">
                      {stats.totalMosques}
                    </Typography>
                    <Typography variant="body2">
                      ÿßŸÑŸÖÿ≥ÿßÿ¨ÿØ ÿßŸÑŸÖÿ¥ÿ±ŸÅ ÿπŸÑŸäŸáÿß
                    </Typography>
                  </Box>
                  <MosqueIcon sx={{ fontSize: 40, opacity: 0.8 }} />
                </Box>
              </Card>
            </Grid>

            <Grid item xs={12} md={6} lg={3}>
              <Card elevation={0} sx={{ p: 2, borderRadius: 3, bgcolor: 'success.light', color: 'success.contrastText' }}>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <Box>
                    <Typography variant="h4" fontWeight="bold">
                      {stats.totalStudents}
                    </Typography>
                    <Typography variant="body2">
                      ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ∑ŸÑÿßÿ®
                    </Typography>
                  </Box>
                  <PeopleIcon sx={{ fontSize: 40, opacity: 0.8 }} />
                </Box>
              </Card>
            </Grid>

            <Grid item xs={12} md={6} lg={3}>
              <Card elevation={0} sx={{ p: 2, borderRadius: 3, bgcolor: 'warning.light', color: 'warning.contrastText' }}>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <Box>
                    <Typography variant="h4" fontWeight="bold">
                      {stats.presentTeachers}/{stats.totalTeachers}
                    </Typography>
                    <Typography variant="body2">
                      ÿßŸÑŸÖÿπŸÑŸÖŸàŸÜ ÿßŸÑÿ≠ÿßÿ∂ÿ±ŸàŸÜ ÿßŸÑŸäŸàŸÖ
                    </Typography>
                  </Box>
                  <SchoolIcon sx={{ fontSize: 40, opacity: 0.8 }} />
                </Box>
              </Card>
            </Grid>

            <Grid item xs={12} md={6} lg={3}>
              <Card elevation={0} sx={{ p: 2, borderRadius: 3, bgcolor: 'info.light', color: 'info.contrastText' }}>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <Box>
                    <Typography variant="h4" fontWeight="bold">
                      {stats.pendingTransfers}
                    </Typography>
                    <Typography variant="body2">
                      ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÜŸÇŸÑ ÿßŸÑŸÖÿπŸÑŸÇÿ©
                    </Typography>
                  </Box>
                  <TransferWithinAStationIcon sx={{ fontSize: 40, opacity: 0.8 }} />
                </Box>
              </Card>
            </Grid>            {/* ÿßŸÑŸÖÿ≥ÿßÿ¨ÿØ ÿßŸÑÿ™Ÿä Ÿäÿ¥ÿ±ŸÅ ÿπŸÑŸäŸáÿß - ŸÖÿ≠ÿØÿ´ ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ API */}
            <Grid item xs={12}>
              <Paper elevation={0} sx={{ p: 3, borderRadius: 3 }}>
                <Typography variant="h6" fontWeight="bold" gutterBottom>
                  ÿßŸÑŸÖÿ≥ÿßÿ¨ÿØ ÿ™ÿ≠ÿ™ ÿ•ÿ¥ÿ±ÿßŸÅŸä
                </Typography>                <Grid container spacing={2}>
                  {Array.from(new Set(supervisorCircles.map(c => c.mosque.id))).map((mosqueId) => {
                    const mosque = supervisorCircles.find(c => c.mosque.id === mosqueId)?.mosque;
                    if (!mosque) return null;
                    
                    const mosqueStudents = supervisorStudents.filter(s => 
                      s.circle && s.circle.mosque && s.circle.mosque.id === mosqueId
                    );
                    const mosqueCircles = supervisorCircles.filter(c => c.mosque.id === mosqueId);
                    const avgScore = mosqueStudents.length > 0 
                      ? mosqueStudents.reduce((sum, s) => sum + (s.total_score || 0), 0) / mosqueStudents.length 
                      : 0;
                    
                    return (
                      <Grid item xs={12} md={6} lg={4} key={mosqueId}>
                        <Card variant="outlined" sx={{ height: '100%' }}>
                          <CardContent>
                            <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>
                              <Avatar sx={{ bgcolor: 'primary.light', mr: 2 }}>
                                <MosqueIcon />
                              </Avatar>
                              <Box>
                                <Typography variant="h6" fontWeight="bold">
                                  {mosque.name}
                                </Typography>
                                <Typography variant="body2" color="text.secondary">
                                  {mosque.location || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
                                </Typography>
                              </Box>
                            </Box>
                            
                            <Divider sx={{ my: 2 }} />
                            
                            <Stack spacing={1}>
                              <Box sx={{ display: 'flex', justifyContent: 'space-between' }}>
                                <Typography variant="body2">ÿπÿØÿØ ÿßŸÑÿ∑ŸÑÿßÿ®:</Typography>
                                <Typography variant="body2" fontWeight="bold">{mosqueStudents.length}</Typography>
                              </Box>
                              <Box sx={{ display: 'flex', justifyContent: 'space-between' }}>
                                <Typography variant="body2">ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿØÿ±ÿ¨ÿßÿ™:</Typography>
                                <Typography variant="body2" fontWeight="bold">{Math.round(avgScore)}%</Typography>
                              </Box>
                              <Box sx={{ display: 'flex', justifyContent: 'space-between' }}>
                                <Typography variant="body2">ÿπÿØÿØ ÿßŸÑÿ≠ŸÑŸÇÿßÿ™:</Typography>
                                <Typography variant="body2" fontWeight="bold">{mosqueCircles.length}</Typography>
                              </Box>
                            </Stack>
                            
                            <Box sx={{ mt: 2 }}>
                              <Button 
                                variant="outlined" 
                                size="small" 
                                fullWidth
                                onClick={() => navigate(`/students?mosque=${mosqueId}`)}
                              >
                                ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
                              </Button>
                            </Box>
                          </CardContent>
                        </Card>
                      </Grid>
                    );
                  })}
                </Grid>
              </Paper>
            </Grid>
          </Grid>
        </TabPanel>

        {/* ÿ™ÿ®ŸàŸäÿ®ÿ© ÿßŸÑŸÖÿ≥ÿßÿ¨ÿØ ŸàÿßŸÑÿ≠ŸÑŸÇÿßÿ™ */}
        <TabPanel value={activeTab} index={1}>
          <Grid container spacing={3}>
            <Grid item xs={12}>
              <Paper elevation={0} sx={{ p: 3, borderRadius: 3 }}>
                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 3 }}>
                  <Typography variant="h6" fontWeight="bold">
                    ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ∑ŸÑÿßÿ® ŸàÿßŸÑÿ≠ŸÑŸÇÿßÿ™
                  </Typography>
                  <Button
                    variant="contained"
                    startIcon={<SwapHorizIcon />}
                    onClick={() => setTransferDialogOpen(true)}
                  >
                    ŸÜŸÇŸÑ ÿ∑ÿßŸÑÿ®
                  </Button>
                </Box>
                  <TableContainer>
                  <Table>
                    <TableHead>
                      <TableRow>
                        <TableCell>ÿßÿ≥ŸÖ ÿßŸÑÿ∑ÿßŸÑÿ®</TableCell>
                        <TableCell>ÿßŸÑŸÖÿ≥ÿ¨ÿØ</TableCell>
                        <TableCell>ÿßŸÑÿ≠ŸÑŸÇÿ©</TableCell>
                        <TableCell>ÿßŸÑÿØÿ±ÿ¨ÿ©</TableCell>
                        <TableCell>ÿßŸÑŸÖÿπŸÑŸÖ</TableCell>
                        <TableCell>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</TableCell>
                      </TableRow>
                    </TableHead>
                    <TableBody>
                      {supervisorStudents.slice(0, 10).map((student) => (
                        <TableRow key={student.id}>
                          <TableCell>
                            <Box sx={{ display: 'flex', alignItems: 'center' }}>
                              <Avatar sx={{ mr: 2, width: 32, height: 32 }}>
                                {student.name ? student.name.charAt(0) : 'ÿü'}
                              </Avatar>
                              <Box>
                                <Typography variant="body2" fontWeight="medium">
                                  {student.name}
                                </Typography>
                                <Typography variant="caption" color="text.secondary">
                                  {student.age} ÿ≥ŸÜÿ©
                                </Typography>
                              </Box>
                            </Box>                          </TableCell>
                          <TableCell>{student.circle && student.circle.mosque ? student.circle.mosque.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</TableCell>
                          <TableCell>
                            <Typography variant="body2">
                              {student.circle ? student.circle.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
                            </Typography>
                          </TableCell>
                          <TableCell>
                            <Box sx={{ display: 'flex', alignItems: 'center' }}>
                              <LinearProgress 
                                variant="determinate" 
                                value={student.total_score || 0} 
                                sx={{ width: 60, mr: 1 }}
                                color={(student.total_score || 0) >= 80 ? "success" : (student.total_score || 0) >= 60 ? "warning" : "error"}
                              />
                              <Typography variant="caption">
                                {student.total_score || 0}%
                              </Typography>
                            </Box>
                          </TableCell>                          <TableCell>
                            <Typography variant="body2">
                              {student.circle && student.circle.teacher ? student.circle.teacher.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
                            </Typography>
                          </TableCell>
                          <TableCell>
                            <IconButton 
                              size="small"
                              onClick={() => navigate(`/student-details/${student.id}`)}
                            >
                              <EditIcon />
                            </IconButton>
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </TableContainer>
              </Paper>
            </Grid>
          </Grid>
        </TabPanel>        {/* ÿ™ÿ®ŸàŸäÿ®ÿ© ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑŸÖÿπŸÑŸÖŸäŸÜ - ŸÖÿ≠ÿØÿ´ ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ API */}
        <TabPanel value={activeTab} index={2}>
          <Grid container spacing={3}>
            <Grid item xs={12}>
              <Paper elevation={0} sx={{ p: 3, borderRadius: 3 }}>
                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 3 }}>
                  <Typography variant="h6" fontWeight="bold">
                    ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿπŸÑŸÖŸäŸÜ - {supervisorTeachers.length} ŸÖÿπŸÑŸÖ
                  </Typography>
                  <Button
                    variant="contained"
                    startIcon={<PersonAddIcon />}
                    onClick={() => setAttendanceDialogOpen(true)}
                  >
                    ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ≠ÿ∂Ÿàÿ±
                  </Button>
                </Box>
                
                <Grid container spacing={2}>
                  {supervisorTeachers.map((teacher) => (
                    <Grid item xs={12} md={6} lg={4} key={teacher.id}>
                      <Card variant="outlined">
                        <CardContent>
                          <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>
                            <Avatar sx={{ mr: 2, bgcolor: 'primary.light' }}>
                              {teacher.name.charAt(0)}
                            </Avatar>
                            <Box>
                              <Typography variant="h6" fontWeight="bold">
                                {teacher.name}
                              </Typography>
                              <Typography variant="body2" color="text.secondary">
                                {teacher.phone}
                              </Typography>
                            </Box>
                          </Box>
                          
                          <Divider sx={{ my: 2 }} />
                          
                          <Stack spacing={1}>                            <Box sx={{ display: 'flex', justifyContent: 'space-between' }}>
                              <Typography variant="body2">ÿßŸÑŸÖÿ≥ÿßÿ¨ÿØ:</Typography>
                              <Typography variant="body2" fontWeight="bold">
                                {teacher.mosques ? teacher.mosques.length : 0}
                              </Typography>
                            </Box>
                            <Box sx={{ display: 'flex', justifyContent: 'space-between' }}>
                              <Typography variant="body2">ÿßŸÑÿ≠ŸÑŸÇÿßÿ™:</Typography>
                              <Typography variant="body2" fontWeight="bold">
                                {teacher.circles_count}
                              </Typography>
                            </Box>
                            <Box sx={{ display: 'flex', justifyContent: 'space-between' }}>
                              <Typography variant="body2">ÿßŸÑÿ∑ŸÑÿßÿ®:</Typography>
                              <Typography variant="body2" fontWeight="bold">
                                {teacher.students_count}
                              </Typography>
                            </Box>
                          </Stack>
                          
                          <Box sx={{ mt: 2 }}>
                            <Typography variant="body2" color="text.secondary" gutterBottom>
                              ÿßŸÑŸÖÿ≥ÿßÿ¨ÿØ:
                            </Typography>                            <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>
                              {teacher.mosques && teacher.mosques.slice(0, 2).map((mosque) => (
                                <Chip 
                                  key={mosque.id}
                                  label={mosque.name}
                                  size="small"
                                  variant="outlined"
                                />
                              ))}
                              {teacher.mosques && teacher.mosques.length > 2 && (
                                <Chip 
                                  label={`+${teacher.mosques.length - 2}`}
                                  size="small"
                                  variant="outlined"
                                  color="primary"
                                />
                              )}
                            </Box>
                          </Box>
                          
                          <Button
                            variant="outlined"
                            size="small"
                            fullWidth
                            startIcon={<EditIcon />}
                            sx={{ mt: 2 }}
                            onClick={() => navigate(`/teacher-details/${teacher.id}`)}
                          >
                            ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
                          </Button>
                        </CardContent>
                      </Card>
                    </Grid>
                  ))}
                </Grid>
              </Paper>
            </Grid>
          </Grid>
        </TabPanel>

        {/* ÿ™ÿ®ŸàŸäÿ®ÿ© ŸÜŸÇŸÑ ÿßŸÑÿ∑ŸÑÿßÿ® */}
        <TabPanel value={activeTab} index={3}>
          <Grid container spacing={3}>
            <Grid item xs={12}>
              <Paper elevation={0} sx={{ p: 3, borderRadius: 3 }}>
                <Typography variant="h6" fontWeight="bold" gutterBottom>
                  ÿ∑ŸÑÿ®ÿßÿ™ ŸÜŸÇŸÑ ÿßŸÑÿ∑ŸÑÿßÿ®
                </Typography>
                
                <TableContainer>
                  <Table>
                    <TableHead>
                      <TableRow>
                        <TableCell>ÿßÿ≥ŸÖ ÿßŸÑÿ∑ÿßŸÑÿ®</TableCell>
                        <TableCell>ŸÖŸÜ</TableCell>
                        <TableCell>ÿ•ŸÑŸâ</TableCell>
                        <TableCell>ÿßŸÑÿ≥ÿ®ÿ®</TableCell>
                        <TableCell>ÿßŸÑÿ≠ÿßŸÑÿ©</TableCell>
                        <TableCell>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ∑ŸÑÿ®</TableCell>
                        <TableCell>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</TableCell>
                      </TableRow>
                    </TableHead>
                    <TableBody>
                      {studentTransferRequests.map((request) => {
                        const fromMosque = mosques.find(m => m.id === request.fromMosqueId);
                        const toMosque = mosques.find(m => m.id === request.toMosqueId);
                        
                        return (
                          <TableRow key={request.id}>
                            <TableCell>{request.studentName}</TableCell>
                            <TableCell>{fromMosque?.name}</TableCell>
                            <TableCell>{toMosque?.name}</TableCell>
                            <TableCell>{request.reason}</TableCell>
                            <TableCell>
                              <Chip 
                                label={request.status === 'pending' ? 'ŸÖÿπŸÑŸÇ' : request.status === 'approved' ? 'ŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸá' : 'ŸÖÿ±ŸÅŸàÿ∂'}
                                color={request.status === 'approved' ? 'success' : request.status === 'pending' ? 'warning' : 'error'}
                                size="small"
                              />
                            </TableCell>
                            <TableCell>{request.requestDate}</TableCell>
                            <TableCell>
                              {request.status === 'pending' && (
                                <Stack direction="row" spacing={1}>
                                  <Button
                                    size="small"
                                    variant="contained"
                                    color="success"
                                    onClick={() => console.log('ŸÖŸàÿßŸÅŸÇÿ© ÿπŸÑŸâ ÿßŸÑŸÜŸÇŸÑ')}
                                  >
                                    ŸÖŸàÿßŸÅŸÇÿ©
                                  </Button>
                                  <Button
                                    size="small"
                                    variant="outlined"
                                    color="error"
                                    onClick={() => console.log('ÿ±ŸÅÿ∂ ÿßŸÑŸÜŸÇŸÑ')}
                                  >
                                    ÿ±ŸÅÿ∂
                                  </Button>
                                </Stack>
                              )}
                            </TableCell>
                          </TableRow>
                        );
                      })}
                    </TableBody>
                  </Table>
                </TableContainer>
              </Paper>
            </Grid>
          </Grid>
        </TabPanel>

        {/* ÿ™ÿ®ŸàŸäÿ®ÿ© ÿßŸÑÿ™ŸàÿµŸäÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ© */}
        <TabPanel value={activeTab} index={4}>
          <Grid container spacing={3}>
            {supervisorAIRecommendations.map((recommendation) => (
              <Grid item xs={12} md={6} key={recommendation.id}>
                <Card 
                  elevation={0}
                  sx={{ 
                    borderRadius: 3,
                    border: '2px solid',
                    borderColor: recommendation.priority === 'high' ? 'error.main' : 
                                recommendation.priority === 'medium' ? 'warning.main' : 'info.main'
                  }}
                >
                  <CardContent>
                    <Box sx={{ display: 'flex', alignItems: 'flex-start', mb: 2 }}>
                      <Avatar 
                        sx={{ 
                          bgcolor: recommendation.priority === 'high' ? 'error.light' : 
                                 recommendation.priority === 'medium' ? 'warning.light' : 'info.light',
                          mr: 2
                        }}
                      >
                        <SmartToyIcon />
                      </Avatar>
                      <Box sx={{ flex: 1 }}>
                        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 1 }}>
                          <Typography variant="h6" fontWeight="bold">
                            {recommendation.title}
                          </Typography>
                          <Chip 
                            label={recommendation.priority === 'high' ? 'ÿπÿßŸÑŸäÿ©' : 
                                   recommendation.priority === 'medium' ? 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©' : 'ŸÖŸÜÿÆŸÅÿ∂ÿ©'}
                            color={recommendation.priority === 'high' ? 'error' : 
                                   recommendation.priority === 'medium' ? 'warning' : 'info'}
                            size="small"
                          />
                        </Box>
                        
                        <Typography variant="body2" color="text.secondary" paragraph>
                          {recommendation.description}
                        </Typography>
                        
                        <Box sx={{ mb: 2 }}>
                          <Typography variant="subtitle2" fontWeight="bold" gutterBottom>
                            ÿßŸÑÿ£ÿ≥ÿ®ÿßÿ®:
                          </Typography>
                          <List dense>
                            {recommendation.reasons.map((reason, index) => (
                              <ListItem key={index} sx={{ py: 0, pl: 0 }}>
                                <ListItemIcon sx={{ minWidth: 20 }}>
                                  <CheckCircleIcon fontSize="small" color="primary" />
                                </ListItemIcon>
                                <ListItemText 
                                  primary={reason}
                                  primaryTypographyProps={{ variant: 'caption' }}
                                />
                              </ListItem>
                            ))}
                          </List>
                        </Box>
                        
                        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <Typography variant="caption" color="text.secondary">
                            ÿØŸÇÿ© ÿßŸÑÿ™ŸàÿµŸäÿ©: {recommendation.confidence}%
                          </Typography>
                          <Button
                            variant="contained"
                            size="small"
                            onClick={() => console.log('ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ŸàÿµŸäÿ©')}
                          >
                            ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ŸàÿµŸäÿ©
                          </Button>
                        </Box>
                      </Box>
                    </Box>
                  </CardContent>
                </Card>
              </Grid>
            ))}
          </Grid>
        </TabPanel>

        {/* ÿ™ÿ®ŸàŸäÿ®ÿ© ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± */}
        <TabPanel value={activeTab} index={5}>
          <Grid container spacing={3}>
            <Grid item xs={12}>
              <Paper elevation={0} sx={{ p: 3, borderRadius: 3 }}>
                <Typography variant="h6" fontWeight="bold" gutterBottom>
                  ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±
                </Typography>
                
                <Grid container spacing={2}>
                  <Grid item xs={12} md={6} lg={3}>
                    <Card variant="outlined" sx={{ p: 2, textAlign: 'center', cursor: 'pointer', '&:hover': { bgcolor: 'action.hover' } }}>
                      <ReportIcon sx={{ fontSize: 40, color: 'primary.main', mb: 1 }} />
                      <Typography variant="h6" fontWeight="bold">
                        ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ∑ŸÑÿßÿ®
                      </Typography>
                      <Typography variant="body2" color="text.secondary">
                        ÿ£ÿØÿßÿ° ÿßŸÑÿ∑ŸÑÿßÿ® ŸàŸÖÿπÿØŸÑÿßÿ™ ÿßŸÑÿ™ŸÇÿØŸÖ
                      </Typography>
                    </Card>
                  </Grid>
                  
                  <Grid item xs={12} md={6} lg={3}>
                    <Card variant="outlined" sx={{ p: 2, textAlign: 'center', cursor: 'pointer', '&:hover': { bgcolor: 'action.hover' } }}>
                      <SchoolIcon sx={{ fontSize: 40, color: 'success.main', mb: 1 }} />
                      <Typography variant="h6" fontWeight="bold">
                        ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿπŸÑŸÖŸäŸÜ
                      </Typography>
                      <Typography variant="body2" color="text.secondary">
                        ÿ≠ÿ∂Ÿàÿ± Ÿàÿ£ÿØÿßÿ° ÿßŸÑŸÖÿπŸÑŸÖŸäŸÜ
                      </Typography>
                    </Card>
                  </Grid>
                  
                  <Grid item xs={12} md={6} lg={3}>
                    <Card variant="outlined" sx={{ p: 2, textAlign: 'center', cursor: 'pointer', '&:hover': { bgcolor: 'action.hover' } }}>
                      <MosqueIcon sx={{ fontSize: 40, color: 'warning.main', mb: 1 }} />
                      <Typography variant="h6" fontWeight="bold">
                        ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ≥ÿßÿ¨ÿØ
                      </Typography>
                      <Typography variant="body2" color="text.secondary">
                        ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿßÿ¨ÿØ ŸàÿßŸÑÿ≠ŸÑŸÇÿßÿ™
                      </Typography>
                    </Card>
                  </Grid>
                  
                  <Grid item xs={12} md={6} lg={3}>
                    <Card variant="outlined" sx={{ p: 2, textAlign: 'center', cursor: 'pointer', '&:hover': { bgcolor: 'action.hover' } }}>
                      <SmartToyIcon sx={{ fontSize: 40, color: 'info.main', mb: 1 }} />
                      <Typography variant="h6" fontWeight="bold">
                        ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä
                      </Typography>
                      <Typography variant="body2" color="text.secondary">
                        ÿ™ŸàÿµŸäÿßÿ™ Ÿàÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿ∞ŸÉŸäÿ©
                      </Typography>
                    </Card>
                  </Grid>
                </Grid>
              </Paper>
            </Grid>
          </Grid>
        </TabPanel>

        {/* ŸÜÿßŸÅÿ∞ÿ© ŸÜŸÇŸÑ ÿßŸÑÿ∑ÿßŸÑÿ® */}
        <Dialog 
          open={transferDialogOpen} 
          onClose={() => setTransferDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>ŸÜŸÇŸÑ ÿ∑ÿßŸÑÿ® ÿ•ŸÑŸâ ŸÖÿ≥ÿ¨ÿØ ÿ¢ÿÆÿ±</DialogTitle>
          <DialogContent>
            <Box sx={{ pt: 2 }}>              <FormControl fullWidth sx={{ mb: 2 }}>
                <InputLabel>ÿßÿÆÿ™ÿ± ÿßŸÑÿ∑ÿßŸÑÿ®</InputLabel>
                <Select
                  value={selectedStudent}
                  onChange={(e) => setSelectedStudent(e.target.value)}
                  label="ÿßÿÆÿ™ÿ± ÿßŸÑÿ∑ÿßŸÑÿ®"
                >                  {supervisorStudents.map((student) => (
                    <MenuItem key={student.id} value={student.id}>
                      {student.name} - {student.circle && student.circle.mosque ? student.circle.mosque.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
              
              <FormControl fullWidth sx={{ mb: 2 }}>
                <InputLabel>ÿßŸÑŸÖÿ≥ÿ¨ÿØ ÿßŸÑÿ¨ÿØŸäÿØ</InputLabel>
                <Select
                  value={targetMosque}
                  onChange={(e) => setTargetMosque(e.target.value)}
                  label="ÿßŸÑŸÖÿ≥ÿ¨ÿØ ÿßŸÑÿ¨ÿØŸäÿØ"
                >
                  {Array.from(new Set(supervisorCircles.map(c => c.mosque.id))).map((mosqueId) => {
                    const mosque = supervisorCircles.find(c => c.mosque.id === mosqueId)?.mosque;
                    return mosque ? (
                      <MenuItem key={mosque.id} value={mosque.id}>
                        {mosque.name}
                      </MenuItem>
                    ) : null;
                  })}
                </Select>
              </FormControl>
              
              <TextField
                fullWidth
                multiline
                rows={3}
                label="ÿ≥ÿ®ÿ® ÿßŸÑŸÜŸÇŸÑ"
                value={transferReason}
                onChange={(e) => setTransferReason(e.target.value)}
                placeholder="ÿßÿ∞ŸÉÿ± ÿ≥ÿ®ÿ® ÿ∑ŸÑÿ® ÿßŸÑŸÜŸÇŸÑ..."
              />
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setTransferDialogOpen(false)}>
              ÿ•ŸÑÿ∫ÿßÿ°
            </Button>
            <Button 
              variant="contained" 
              onClick={handleStudentTransfer}
              disabled={!selectedStudent || !targetMosque || !transferReason}
            >
              ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑŸÜŸÇŸÑ
            </Button>
          </DialogActions>
        </Dialog>

        {/* ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑŸÖÿπŸÑŸÖ */}
        <Dialog 
          open={attendanceDialogOpen} 
          onClose={() => setAttendanceDialogOpen(false)}
          maxWidth="sm"
          fullWidth
        >
          <DialogTitle>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ≠ÿ∂Ÿàÿ± ÿßŸÑŸÖÿπŸÑŸÖ</DialogTitle>
          <DialogContent>
            <Box sx={{ pt: 2 }}>              <FormControl fullWidth sx={{ mb: 2 }}>
                <InputLabel>ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿπŸÑŸÖ</InputLabel>
                <Select
                  value={selectedTeacher}
                  onChange={(e) => setSelectedTeacher(e.target.value)}
                  label="ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿπŸÑŸÖ"
                >                  {supervisorTeachers.map((teacher) => (
                    <MenuItem key={teacher.id} value={teacher.id}>
                      {teacher.name} - {teacher.mosques ? teacher.mosques.map(m => m.name).join(', ') : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
              
              <FormControl fullWidth sx={{ mb: 2 }}>
                <InputLabel>ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿ∂Ÿàÿ±</InputLabel>
                <Select
                  value={attendanceStatus}
                  onChange={(e) => setAttendanceStatus(e.target.value)}
                  label="ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿ∂Ÿàÿ±"
                >
                  <MenuItem value="ÿ≠ÿßÿ∂ÿ±">ÿ≠ÿßÿ∂ÿ±</MenuItem>
                  <MenuItem value="ÿ∫ÿßÿ¶ÿ®">ÿ∫ÿßÿ¶ÿ®</MenuItem>
                  <MenuItem value="ŸÖÿ™ÿ£ÿÆÿ±">ŸÖÿ™ÿ£ÿÆÿ±</MenuItem>
                  <MenuItem value="ÿ•ÿ¨ÿßÿ≤ÿ©">ÿ•ÿ¨ÿßÿ≤ÿ©</MenuItem>
                </Select>
              </FormControl>
              
              <TextField
                fullWidth
                multiline
                rows={3}
                label="ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™"
                value={attendanceNotes}
                onChange={(e) => setAttendanceNotes(e.target.value)}
                placeholder="ÿ£ÿ∂ŸÅ ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©..."
              />
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setAttendanceDialogOpen(false)}>
              ÿ•ŸÑÿ∫ÿßÿ°
            </Button>
            <Button 
              variant="contained" 
              onClick={handleTeacherAttendance}
              disabled={!selectedTeacher || !attendanceStatus}
            >
              ÿ≠ŸÅÿ∏ ÿßŸÑÿ≠ÿ∂Ÿàÿ±
            </Button>
          </DialogActions>
        </Dialog>
      </Container>
    </Box>
  );
};

export default SupervisorDashboard;
